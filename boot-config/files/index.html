#!/bin/sh
echo 
echo "<title>boot-config</title>"
echo "<table align=center border=0><tr><td>"
echo `cat /www/menu.html`
echo "</td></tr></table>"

echo "
<body bgcolor="#f0f0f0">
<style>
.button{text-decoration:none; text-align:center; 
 padding:5px 10px; 
 border:solid 1px #004F72; 
 -webkit-border-radius:20px;
 -moz-border-radius:20px; 
 border-radius: 20px; 
 font:15px Arial, Helvetica, sans-serif; 
 font-weight:bold; 
 color:#ffffff; 
 background-color:#3BA4C7; 
 background-image: -moz-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -webkit-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -o-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -ms-linear-gradient(top, #3BA4C7 0% ,#1982A5 100%); 
 filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#1982A5', endColorstr='#1982A5',GradientType=0 ); 
 background-image: linear-gradient(top, #3BA4C7 0% ,#1982A5 100%);   
 -webkit-box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff; 
 -moz-box-shadow: 0px 0px 2px #bababa,  inset 0px 0px 1px #ffffff;  
 box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;  
  
  }.button:hover{
 padding:5px 10px; 
 border:solid 1px #004F72; 
 -webkit-border-radius:20px;
 -moz-border-radius:20px; 
 border-radius: 20px; 
 font:15px Arial, Helvetica, sans-serif; 
 font-weight:bold; 
 color:#000000; 
 background-color:#3BA4C7; 
 background-image: -moz-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -webkit-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -o-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -ms-linear-gradient(top, #3BA4C7 0% ,#1982A5 100%); 
 filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#1982A5', endColorstr='#1982A5',GradientType=0 ); 
 background-image: linear-gradient(top, #3BA4C7 0% ,#1982A5 100%);   
 -webkit-box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff; 
 -moz-box-shadow: 0px 0px 2px #bababa,  inset 0px 0px 1px #ffffff;  
 box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;  
  
 }.button:active{
 padding:5px 10px; 
 border:solid 1px #004F72; 
 -webkit-border-radius:10px;
 -moz-border-radius:10px; 
 border-radius: 10px; 
 font:15px Arial, Helvetica, sans-serif; 
 font-weight:bold; 
 color:#ffffff; 
 background-color:#3BA4C7; 
 background-image: -moz-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -webkit-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -o-linear-gradient(top, #3BA4C7 0%, #1982A5 100%); 
 background-image: -ms-linear-gradient(top, #3BA4C7 0% ,#1982A5 100%); 
 filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#1982A5', endColorstr='#1982A5',GradientType=0 ); 
 background-image: linear-gradient(top, #3BA4C7 0% ,#1982A5 100%);   
 -webkit-box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff; 
 -moz-box-shadow: 0px 0px 2px #bababa,  inset 0px 0px 1px #ffffff;  
 box-shadow:0px 0px 2px #bababa, inset 0px 0px 1px #ffffff;  
  
 }
  .b2 {
height: 10px;
text-align: center;
padding: 1px;
border: 3px solid #0000cc;
border-radius: 10px;
}
</style><br>"
#***************************************************************
board=$(cat /tmp/sysinfo/board_name)
model=$(cat /tmp/sysinfo/model)
boardname="${board##*,}"
backup='/boot/dtb.backup'
dts='/tmp/t-dts'
wifi='mmc@1c10000'
w1='w1'
ir='ir@1f02000'
pwm='pwm@1c21400'
i2c0='i2c@1c2ac00\|i2c@01c2ac00'
i2c1='i2c@1c2b000\|i2c@01c2b000'
i2c2='i2c@1c2b400\|i2c@01c2b400'
audcodec='codec@1c22c00\|codec@01c22c00'
uart0='serial@1c28000'
uart1='serial@1c28400'
uart2='serial@1c28800'
usb_otg='usb@1c19000'
ehci0='usb@1c1a000'
ohci0='usb@1c1a400'
ehci1='usb@1c1b000'
ohci1='usb@1c1b400'
ehci2='usb@1c1c000'
ohci2='usb@1c1c400'
ehci3='usb@1c1d000'
ohci3='usb@1c1d400'
spi0='spi@1c68000'
spi1='spi@1c69000'
#***************************************************************

stachec () {
if [ "$mod" == "okay" ]; then
yss="hidden"
noo=""
checked=checked
checked1=""
sost=okay
sost1=disabled
sost2=okay
sinvers=Disable
bgcolor="#76cc00"
else
bgcolor=""
sost2=disabled
sost1=okay
yss=""
noo="hidden"
checked=""
checked1=checked
sost=disabled
sinvers=Enable
fi
}

stausb () {
if [[ "$ehci" == "okay" && "$ohci" == "okay" ]]; then
checusb=checked
checusb1=""
sostusb1=disabled
sostusb2=okay
else
checusb=""
checusb1=checked
sostusb1=okay
sostusb2=disabled
fi
}

if [ "$1" == "1" ]; then
echo "The device reboots.  And will be available in <b><span id="time"></span></b> seconds.
<script type="text/javascript">var i = 30; function time(){ document.getElementById(\"time\").innerHTML = i; i--; if (i < 0) location.href = \"/index.html\"; }
time(); setInterval(time, 1000); </script>"
reboot
fi

cat $dts &> /dev/null
if [ $? = 1 ]; then
dtc -I dtb -O dts -o $dts /boot/dtb
sleep 1
fi

cat $dts &> /dev/null
if [ $? = 1 ]; then
echo "<table align="center" border=0 width=><tr><td>"
echo "Not mounted <b>/dev/mmcblk0p1 in /boot.</b><br>"
echo "You must install <b>mount-utils.</b><br>"
echo "Reboot device. And make changes to the config.<br><br>"
echo "uci set fstab.@mount[0].target=/boot<br>"
echo "uci set fstab.@mount[0].enabled=1<br>"
echo "uci commit fstab<br><br>"
echo "</td></tr></table>"
nomount='disabled'
fi

echo "<table align="center" border=0 width=>
<form method="POST" action="conv.cgi"><tr>
<td>
<a href=/cgi-bin/modules/boot-config/conv.cgi>
<button class="button" $nomount type=submit name="conv" value="dts" title="Device_tree_compile_for_flat_device_trees.">"Convert dtb to dts."</button></a>
</td>
<td>"
cat $backup &> /dev/null
if [ $? = 1 ]; then
echo "<a href=/cgi-bin/modules/boot-config/conv.cgi>
<button class="button" $nomount type=submit name="backup" value="dtb">"Create a backup of u-boot, dtb-file"</button></a>"
fi
echo "</td>
</tr></form></table>"
#***************************************************************

echo "<form method="POST" action="Save.cgi" $nomount>"
echo "
<table align=center>"

#*************

if [[ "$boardname" == "orangepi-zero" || "$boardname" == "orangepi-zero-lts" ]]; then
echo "<tr><td align="center"><table class="b2" border="1" cols="4" bgcolor="#ffffff" cellspacing="10">
<caption>$model</br>"Turn on/off the power of the xr819 radio module."</caption>"
echo "<tr><td>"
mod=$(cat $dts | sed -n '/'$wifi'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="wifi" value="disabled" $sost2 $checked1>OFF
<input type=radio name="wifi" value="okay" $sost1 $checked>ON
</td>
<td align="center">"Wifi: xradio, xr819"</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td bgcolor="$bgcolor">"
if [ "$sost2" == "disabled" ]; then
echo "vcc-wifi: disabled"
elif [ "$sost2" == "okay" ]; then
echo "vcc-wifi: enabled"
fi
echo "</td></tr>
</table></td></tr>"
fi
#*************

echo "<tr><td><table class="b2" border=2 cols="4" bgcolor="#ffffff" cellspacing="10">
<caption>sun8i: Allwinner H2+, H3. General U-boot settings.</caption>
<tr><td>"
mod=$(cat $dts | sed -n '/'$i2c0'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="i2c0" value="disabled" $sost2 $checked1>OFF
<input type=radio name="i2c0" value="okay" $sost1 $checked>ON
</td>
<td align="center">"i2c0: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/i2c0 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>"

echo "<tr><td>"
mod=$(cat $dts | sed -n '/'$i2c1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="i2c1" value="disabled" $sost2 $checked1>OFF
<input type=radio name="i2c1" value="okay" $sost1 $checked>ON
</td>
<td align="center">"i2c1: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/i2c1 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$i2c2'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="i2c2" value="disabled" $sost2 $checked1>OFF
<input type=radio name="i2c2" value="okay" $sost1 $checked>ON
<td align="center">"i2c2: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/i2c2 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$w1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="w1" value="disabled" $sost2 $checked1>OFF
<input type=radio name="w1" value="okay" $sost1 $checked>ON
</td>
<td align="center">"w1: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/w1_pins {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$ir'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="ir" value="disabled" $sost2 $checked1>OFF
<input type=radio name="ir" value="okay" $sost1 $checked>ON
</td>
<td align="center">"irc: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/ir {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$uart0'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="uart0" value="disabled" $sost2 $checked1>OFF
<input type=radio name="uart0" value="okay" $sost1 $checked>ON
<td align="center">"uart0: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td bgcolor="#f0a0f0">"
echo "Gpio: "
cat $dts | sed -n '/uart0 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$uart1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="uart1" value="disabled" $sost2 $checked1>OFF
<input type=radio name="uart1" value="okay" $sost1 $checked>ON
</td>
<td align="center">"uart1: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/uart1 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>

<tr>
<td>"
mod=$(cat $dts | sed -n '/'$uart2'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="uart2" value="disabled" $sost2 $checked1>OFF
<input type=radio name="uart2" value="okay" $sost1 $checked>ON
</td>
<td align="center">"uart2: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td>"
echo "Gpio: "
cat $dts | sed -n '/uart2 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /'
echo "</td></tr>"



#***************************************************************
echo "
<tr>
<td>"
mod=$(cat $dts | sed -n '/'$pwm'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="pwm" value="disabled" $sost2 $checked1>OFF
<input type=radio name="pwm" value="okay" $sost1 $checked>ON
</td>
<td align="center">"pwm0: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td>
<td bgcolor="#f0a0f0">"
echo "Gpio: "
cat $dts | sed -n '/pwm0@0 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p'
echo " - UART0_RX"
echo "</td></tr>"
#****************************************************************

echo "<tr><td>"
mod=$(cat $dts | sed -n '/'$spi0'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="spi0" value="disabled" $sost2 $checked1>OFF
<input type=radio name="spi0" value="okay" $sost1 $checked>ON
</td>
<td align="center">"spi0: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>"
echo "Flash: "
cat $dts | sed -n '/spi0 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /g'
echo "</td></tr>"

echo "<tr><td>"
mod=$(cat $dts | sed -n '/'$spi1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="spi1" value="disabled" $sost2 $checked1>OFF
<input type=radio name="spi1" value="okay" $sost1 $checked>ON
</td>
<td align="center">"spi1: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>"
echo "Gpio: "
cat $dts | sed -n '/spi1 {/,/\};/p' | sed -n 's/.*pins.*\"\(.*\)\".*/\1/p' | sed 's/\\0/, /g'
echo "</td></tr>"

#***************************************************************

echo "<tr>
<td>"
mod=$(cat $dts | sed -n '/'$audcodec'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="audcodec" value="disabled" $sost2 $checked1>OFF
<input type=radio name="audcodec" value="okay" $sost1 $checked>ON
</td>
<td align="center">"Analog-audio-codec: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>Soc-IN/Out</td></tr>

<tr><td>"
mod=$(cat $dts | sed -n '/'$usb_otg'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stachec
echo "
<input type=radio name="usb_otg" value="disabled" $sost2 $checked1>OFF
<input type=radio name="usb_otg" value="okay" $sost1 $checked>ON
</td>
<td align="center">"usb_otg: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>---</td></tr>"
#***************************************************************



echo "
<tr><td>"
ehci=$(cat $dts | sed -n '/'$ehci0'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
ohci=$(cat $dts | sed -n '/'$ohci0'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stausb
echo "
<input type=radio name="usb0" value="disabled" $sostusb2 $checusb1>OFF
<input type=radio name="usb0" value="okay" $sostusb1 $checusb>ON
</td>
<td align="center">"usb0: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>---</td></tr>"
#***************************************************************


echo "
<tr><td>"
ehci=$(cat $dts | sed -n '/'$ehci1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
ohci=$(cat $dts | sed -n '/'$ohci1'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stausb
echo "
<input type=radio name="usb1" value="disabled" $sostusb2 $checusb1>OFF
<input type=radio name="usb1" value="okay" $sostusb1 $checusb>ON
</td>
<td align="center">"usb1: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>---</td></tr>"
#***************************************************************


echo "
<tr><td>"
ehci=$(cat $dts | sed -n '/'$ehci2'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
ohci=$(cat $dts | sed -n '/'$ohci2'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stausb
echo "
<input type=radio name="usb2" value="disabled" $sostusb2 $checusb1>OFF
<input type=radio name="usb2" value="okay" $sostusb1 $checusb>ON
</td>
<td align="center">"usb2: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>---</td></tr>"
#***************************************************************


echo "
<tr><td>"
ehci=$(cat $dts | sed -n '/'$ehci3'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
ohci=$(cat $dts | sed -n '/'$ohci3'/,/\};/p' | sed -n 's/.*status.*\"\(.*\)\".*/\1/p')
stausb
echo "
<input type=radio name="usb3" value="disabled" $sostusb2 $checusb1>OFF
<input type=radio name="usb3" value="okay" $sostusb1 $checusb>ON
</td>
<td align="center">"usb3: "</td><td bgcolor="$bgcolor"><b>"$sost2"</b></td></td><td>---</td></tr>"

echo "</table></td></tr>
<table align="center" border=0 width=><tr><td>
<a href=/cgi-bin/modules/boot-config/Save.cgi>
<button class="button" type=submit value="Save" $nomount name=>"Save changes."</button></a>
</td></tr></table>

</table></form>"

echo "<table align="center" border=0 width=>
<form method="POST" action="conv.cgi"><tr>
<td>
<a href=/cgi-bin/modules/boot-config/conv.cgi>
<button class="button" $nomount type=submit name="reconv" value="dtb" title="Compile_of_device_tree.">"Apply changes, and reboot device."</button></a>
</td>
</tr></form></table></body>"

